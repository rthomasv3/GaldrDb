name: Release Browser

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-platforms:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            os-name: macos
            runtime: osx-x64
          - platform: macos-latest
            os-name: macos-arm64
            runtime: osx-arm64
          - platform: ubuntu-latest
            os-name: linux
            runtime: linux-x64
          - platform: windows-latest
            os-name: windows
            runtime: win-x64

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install frontend dependencies
        run: npm install
        working-directory: GaldrDbBrowser/FrontEnd

      - name: Build frontend
        run: npm run build
        working-directory: GaldrDbBrowser/FrontEnd

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

      - name: Publish Release
        run: dotnet publish "GaldrDbBrowser/GaldrDbBrowser.csproj" -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishTrimmed=True -p:TrimMode=Full -p:PublishAot=true -p:AssemblyName=GaldrDbBrowser

      # Windows: Collect release files
      - name: Package Windows Release
        if: matrix.os-name == 'windows'
        run: |
          mkdir release
          copy ".\GaldrDbBrowser\bin\Release\net10.0\win-x64\publish\GaldrDbBrowser.exe" release\
          copy ".\GaldrDbBrowser\bin\Release\net10.0\win-x64\publish\webview.dll" release\
          copy ".\GaldrDbBrowser\bin\Release\net10.0\win-x64\publish\nfd.dll" release\
        shell: cmd

      - name: Upload Windows Artifact
        if: matrix.os-name == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: GaldrDbBrowser-${{ inputs.version }}-win-x64
          path: release/*

      # Linux: Collect release files
      - name: Package Linux Release
        if: matrix.os-name == 'linux'
        run: |
          mkdir release
          cp "./GaldrDbBrowser/bin/Release/net10.0/linux-x64/publish/GaldrDbBrowser" release/
          cp ./GaldrDbBrowser/bin/Release/net10.0/linux-x64/publish/libwebview.so release/ || true
          cp ./GaldrDbBrowser/bin/Release/net10.0/linux-x64/publish/libnfd.so release/ || true

      - name: Upload Linux Artifact
        if: matrix.os-name == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: GaldrDbBrowser-${{ inputs.version }}-linux-x64
          path: release/*

      # macOS x86-64: Collect release files
      - name: Package macOS x86-64 Release
        if: matrix.os-name == 'macos'
        run: |
          mkdir release
          cp "./GaldrDbBrowser/bin/Release/net10.0/osx-x64/publish/GaldrDbBrowser" release/
          cp ./GaldrDbBrowser/bin/Release/net10.0/osx-x64/publish/libwebview.dylib release/ || true
          cp ./GaldrDbBrowser/bin/Release/net10.0/osx-x64/publish/libnfd.dylib release/ || true

      - name: Upload macOS x86-64 Artifact
        if: matrix.os-name == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: GaldrDbBrowser-${{ inputs.version }}-osx-x64
          path: release/*

      # macOS arm64: Collect release files
      - name: Package macOS arm64 Release
        if: matrix.os-name == 'macos-arm64'
        run: |
          mkdir release-arm
          cp "./GaldrDbBrowser/bin/Release/net10.0/osx-arm64/publish/GaldrDbBrowser" release-arm/
          cp ./GaldrDbBrowser/bin/Release/net10.0/osx-arm64/publish/libwebview.dylib release-arm/ || true
          cp ./GaldrDbBrowser/bin/Release/net10.0/osx-arm64/publish/libnfd.dylib release-arm/ || true

      - name: Upload macOS arm64 Artifact
        if: matrix.os-name == 'macos-arm64'
        uses: actions/upload-artifact@v4
        with:
          name: GaldrDbBrowser-${{ inputs.version }}-osx-arm64
          path: release-arm/*

  build-appimage:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            curl \
            git \
            file \
            build-essential \
            python3 \
            python3-pip \
            ca-certificates \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libc6-dev \
            libglib2.0-dev \
            libsecret-1-dev

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Build AppImage
        run: |
          cd GaldrDbBrowser/AppImage
          bash build-appimage.sh

      - name: Rename AppImage with version
        run: |
          mv GaldrDbBrowser/AppImage/output/GaldrDbBrowser-x86_64.AppImage GaldrDbBrowser/AppImage/output/GaldrDbBrowser-${{ inputs.version }}-x86_64.AppImage

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GaldrDbBrowser-${{ inputs.version }}-AppImage
          path: GaldrDbBrowser/AppImage/output/GaldrDbBrowser-${{ inputs.version }}-x86_64.AppImage
          if-no-files-found: error

  create-release:
    needs: [build-platforms, build-appimage]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Zip artifacts for release
        run: |
          cd artifacts/GaldrDbBrowser-${{ inputs.version }}-win-x64 && zip -r ../../GaldrDbBrowser-${{ inputs.version }}-win-x64.zip . && cd ../..
          cd artifacts/GaldrDbBrowser-${{ inputs.version }}-linux-x64 && zip -r ../../GaldrDbBrowser-${{ inputs.version }}-linux-x64.zip . && cd ../..
          cd artifacts/GaldrDbBrowser-${{ inputs.version }}-osx-x64 && zip -r ../../GaldrDbBrowser-${{ inputs.version }}-osx-x64.zip . && cd ../..
          cd artifacts/GaldrDbBrowser-${{ inputs.version }}-osx-arm64 && zip -r ../../GaldrDbBrowser-${{ inputs.version }}-osx-arm64.zip . && cd ../..

      - name: Create Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create browser-v${{ inputs.version }} \
            --draft \
            --title "GaldrDb Browser v${{ inputs.version }}" \
            --notes "GaldrDb Browser version ${{ inputs.version }}" \
            GaldrDbBrowser-${{ inputs.version }}-win-x64.zip \
            GaldrDbBrowser-${{ inputs.version }}-linux-x64.zip \
            GaldrDbBrowser-${{ inputs.version }}-osx-x64.zip \
            GaldrDbBrowser-${{ inputs.version }}-osx-arm64.zip \
            artifacts/GaldrDbBrowser-${{ inputs.version }}-AppImage/GaldrDbBrowser-${{ inputs.version }}-x86_64.AppImage

      - name: Release Summary
        run: |
          echo "=== Release Created ===" >> $GITHUB_STEP_SUMMARY
          echo "Version: browser-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: Draft" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- GaldrDbBrowser-${{ inputs.version }}-win-x64.zip" >> $GITHUB_STEP_SUMMARY
          echo "- GaldrDbBrowser-${{ inputs.version }}-linux-x64.zip" >> $GITHUB_STEP_SUMMARY
          echo "- GaldrDbBrowser-${{ inputs.version }}-osx-x64.zip" >> $GITHUB_STEP_SUMMARY
          echo "- GaldrDbBrowser-${{ inputs.version }}-osx-arm64.zip" >> $GITHUB_STEP_SUMMARY
          echo "- GaldrDbBrowser-${{ inputs.version }}-x86_64.AppImage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Draft release ready for review" >> $GITHUB_STEP_SUMMARY
